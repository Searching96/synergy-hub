services:
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: synergyhub-backend
    ports:
      - "127.0.0.1:8080:8080" # Bound to localhost, proxy via your existing Nginx
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DATABASE_URL=jdbc:mysql://db:3306/synergy_hub?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - DATABASE_USERNAME=${DB_USER}
      - DATABASE_PASSWORD=${DB_PASSWORD}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL}
      - JWT_SECRET=${JWT_SECRET}
      - DB_ENCRYPTION_KEY=${DB_ENCRYPTION_KEY}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      # Email Configuration
      - MAIL_HOST=${MAIL_HOST:-smtp.gmail.com}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_SSL_ENABLE=${MAIL_SSL_ENABLE:-false}
      - MAIL_STARTTLS_ENABLE=${MAIL_STARTTLS_ENABLE:-true}
      - FRONTEND_URL=${FRONTEND_URL:-https://thinhuit.id.vn}
      # OAuth2 Configuration (optional)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      # LiveKit Configuration
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - LIVEKIT_URL=${LIVEKIT_URL:-ws://livekit:7880}
    depends_on:
      - db
    restart: unless-stopped
    networks:
      - synergyhub-network

  db:
    image: mariadb:10.6
    container_name: synergyhub-db
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - ./mysql-data:/var/lib/mysql
    restart: unless-stopped
    networks:
      - synergyhub-network

  redis:
    image: redis:7-alpine
    container_name: synergyhub-redis
    restart: unless-stopped
    networks:
      - synergyhub-network

  livekit:
    image: livekit/livekit-server:latest
    container_name: synergyhub-livekit
    command: --config /etc/livekit.yaml
    ports:
      - "127.0.0.1:7880:7880" # Signaling: Proxy via your existing Nginx
      - "7881:7881"           # WebRTC TCP: Must be public
      - "7882:7882/udp"       # WebRTC UDP: Must be public
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    depends_on:
      - redis
    environment:
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET}"
    restart: unless-stopped
    networks:
      - synergyhub-network

networks:
  synergyhub-network:
    driver: bridge
